---
title: "Statistical Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
---


```{r setup, include=FALSE}
library(MASS)
library(tidyverse)
library(Hmisc)
library(corrplot)

# set knitr defaults
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE
)

# set theme defaults
theme_set(theme_minimal() + theme(legend.position = "bottom"))

# set color scale defaults
options(
    ggplot2.continuous.colour = "viridis",
    ggplot2.continuous.fill   = "viridis")

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete   = scale_fill_viridis_d
```

## Methodology

Based on the results in exploratory data analysis, it is clear that deaths and damage by volcanic eruptions can be affected by factors like earthquake, tsunami and VEI of the volcano. To better describe their relationship, in this part, We utilize descriptive data on personnel fatalities and property losses from the dataset, and since they are ordinal categorical variables, we use **ordinal logistic regression** to assess the association between predictors and the ordinal outcomes.

We use the `polr` command from the MASS package to estimate an ordered logistic regression model. We also specify `Hess=TRUE` to have the model return the observed information matrix from optimization (called the Hessian) which is used to get standard errors.

### Definition
An ordinal variable is a categorical variable in which the levels have a natural ordering. Let $Y$ be an ordinal outcome with $J$ categories. Then $P(Y≤j)$is the cumulative probability of $Y$ less than or equal to a specific category
$j=1,...J-1$. The odds of being less than or equal a particular category can be defined as
$$\frac{P(Y≤j)}{P(Y>j)}$$
for $j=1,...J-1$ since $P(Y>j) = 0$ and dividing by zero is undefined. The **log odds** is also known as the **logit**, so that
$$log\frac{P(Y≤j)}{P(Y>j)}=logit(P(Y≤j))$$
In R’s polr the ordinal logistic regression model is parameterized as
$$logit(P(Y≤j))=β_{j0}-η_{1}x_{1}-η_{2}x_{2}-...-η_{p}x_{p}$$

### Application

We use the **ordinal logistic regression** to evaluate the effect of several factors on casualties and property losses which are the outcomes we are interested in. Predictors are tsunami, earthquake and VEI in this model. Our ordinal logistic regression model can be parameterized as:
$$logit(P(Y≤j))=β_{j0}-η_{1}X_{1}-η_{2}X_{2}-η_{3}X_{3}$$
where,  

* $β_{j0}$is an intercept and represents the log-odds of $Y≤j$ when all the predictors are at 0 or their reference level. 
* $X_{1}$ is tsunami, $X_{2}$ is earthquake, $X_{3}$ is VEI.
* Each $-η_{k}$ for $k = 1,2,3$ is the log of the odds ratio comparing the odds of $Y≤j$ between individuals who differ by 1-unit in $X_{k}$.

## Correlation Analysis

First, we perform a correlation analysis. If two predictors have strong correlation, we can only keep one of them in our regression model. This careful consideration ensures the avoidance of multicollinearity, thereby enhancing the precision and interpretability of our model's results.

Correlation between the variables is shown by the following heatmap:
```{r}
# Import tidied data
tidy_df = 
  read.csv2("data/volcanic-eruption-final.csv", sep = ",", stringsAsFactors = TRUE)
  

# Select variables of interest
selected_data <- 
  tidy_df |>
  dplyr::select(flag_earthquake, flag_tsunami, volcanic_explosivity_index, elevation)

cor_matrix <- rcorr(as.matrix(selected_data), type = "spearman")

correlation_matrix <- cor_matrix$r
p_value_matrix <- cor_matrix$P
p_value_matrix[is.na(p_value_matrix)] <- 1
corrplot(correlation_matrix, p.mat = p_value_matrix, method = "color",
         tl.col = "black", tl.srt = 45, tl.offset = 0.5, tl.cex = 0.8,
         sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.9, pch.col = "grey20",
         tl.pos = "lt", insig = "label_sig", type = "upper")
corrplot(correlation_matrix, type = "lower", add = TRUE, method = "number",
         tl.pos = "n", cl.pos = "n")
```

From the results of correlation analysis, we can see that there is a positive correlation between `flag_tsunami` and `flag_earthquake`. However, correlation coefficient (r) is 0.35, indicating only a moderate correlation. Therefore, we'll include both `flag_tsunami` and `flag_earthquake` in our later analysis.   
We also notice that there is a negative correlation between `elevation` and `flag_tsunami`. This is probably because volcanoes under the sea are more likely to cause tsunami.



## Fit the Ordinal Logistic Regression Model

Then we can fit the following ordinal logistic regression model:

volcano_deaths_description ~ flag_earthquake + flag_tsunami + volcanic_explosivity_index + elevation
```{r}
death_df = 
  tidy_df |>
  filter(volcano_deaths_description != "None/No Record")

logistic_model <- polr(volcano_deaths_description ~ flag_earthquake + flag_tsunami + volcanic_explosivity_index + elevation, data = death_df, Hess=TRUE)

## view a summary of the model
logistic_model |> broom::tidy() |> knitr::kable()
```


The estimated model can be written as:

...
...
...

Some people require a p value to be satisfied. In this situation, comparing the t-value to the conventional normal distribution using a z test is one method of computing a p-value. This is only true when there are infinite degrees of freedom, but large samples can well approximate it; as sample size drops, the sample becomes more biased. This method is simple to implement and is utilized in other software programs like Stata. We compute the p-values and then merge them back with the table after storing the coefficient table.
```{r}
## store table
ctable2 <- coef(summary(logistic_model))

## calculate and store p values
p <- pnorm(abs(ctable2[, "t value"]), lower.tail = FALSE) * 2

## combined table
ctable2 <- cbind(ctable2, "p value" = p)

knitr::kable(ctable2)

```
Interpretation:

All the four predictors (`flag_earthquake`, `flag_tsunami`, `volcanic_explosivity_index`, `elevation`) have a p value less than 0.05, indicating that all of them are statistically significant.




We can also get confidence intervals for the parameter estimates. These can be obtained either by profiling the likelihood function or by using the standard errors and assuming a normal distribution. Note that profiled CIs are not symmetric (although they are usually close to symmetric). If the 95% CI does not cross 0, the parameter estimate is statistically significant.
```{r}
# default method gives profiled CIs
# (ci <- confint(logistic_model)) 

# CIs assuming normality
ci = confint.default(logistic_model) 
```
Interpretation:



Another way to interpret logistic regression models is to convert the coefficients into odds ratios. To get the OR and confidence intervals, we just exponentiate the estimates and confidence intervals.
```{r}
## odds ratios
exp(coef(logistic_model))

## OR and CI
exp(cbind(OR = coef(logistic_model), ci))

```
Interpretation:
