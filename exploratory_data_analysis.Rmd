---
title: "Exploratory Data Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
---

```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)
library(cowplot)

# set knitr defaults
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE
)

# set theme defaults
theme_set(theme_minimal() + theme(legend.position = "bottom"))

# set color scale defaults
options(
    ggplot2.continuous.colour = "viridis",
    ggplot2.continuous.fill   = "viridis")

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete   = scale_fill_viridis_d
```

## Data Cleaning and Processing

(Describe the steps in data cleaning)

```{r}
tidy_df = 
  read.csv(
    "data/significant-volcanic-eruption-database.csv", 
    sep = ";", na.strings=c("", NA)) |>
  janitor::clean_names() |>
  select(
    -c(month, day, location, status, volcano_missing, volcano_missing_description, earthquakes_houses_damaged_description),
    -starts_with("total")
    ) |>
  mutate(
    flag_tsunami = case_match(flag_tsunami, "Tsunami"~ 1, NA ~ 0),
    flag_earthquake = case_match(flag_earthquake, "Earthquake"~ 1, NA ~ 0)
  ) |>
  separate(coordinates, into = c("lat", "long"), sep = ",") |>
  mutate(
    lat = as.numeric(lat), long = as.numeric(long)
  ) |>
  mutate_at(vars(ends_with('description')), ~ifelse(is.na(.), "None/No Record", .))

```

The final dataset used in the analysis has the following key variables:

* `year`: the year of eruption
* `flag_tsunami`: specifies whether there is a tsunami accompanying the volcanic eruption (1: with tsunami, 0: no tsunami)
* `flag_earthquake`: specifies whether there is an earthquake accompanying the volcanic eruption (1: with earthquake, 0: no earthquake)
* `volcano_name`: the name of the volcano
* `country`: the country where the volcano is located
* `elevation`: the elevation of the volcano
* `volcano_type`: the type of the volcano
* `volcanic_explosivity_index`          
* `volcano_deaths`                      
* `volcano_deaths_description`         
* `volcano_injuries`                    
* `volcano_injuries_description`       
* `volcano_damage_in_m`                
* `volcano_damage_description`         
* `volcano_houses_destroyed`             
* `volcano_houses_destroyed_description`
* `lat`                                 
* `long`


## Geographical Distribution of Volcanic Eruptions

First, we want to figure out which countries or regions are most prone to volcanic eruptions, so we make an interactive map to display the geographical distribution of volcanoes.

```{r}
geo_df = 
  tidy_df |>
  select(volcano_name, country, volcano_type, elevation, lat, long) |>
  group_by(volcano_name, country, volcano_type, elevation, lat, long) |>
  summarise(eruption_count = n())

geo_df |>
  filter(eruption_count >= 2) |>
  leaflet() |>
  addTiles() |>
  addProviderTiles(providers$CartoDB.Positron) |>
  addMarkers(lat = ~lat, 
             lng = ~long, 
             clusterOptions = markerClusterOptions(),
             label = ~paste(
               "Name: ", volcano_name, "<br>",
               "Country: ", country, "<br>",
               "Volcano Type: ", volcano_type, "<br>",
               "Elevation: ", elevation, "<br>",
               "Eruption Count: ", eruption_count) |> lapply(htmltools::HTML)) 
```

We can notice that most volcanoes are located at the edge of the continents. This pattern is a result of the tectonic plate boundaries where volcanic activity is often concentrated. 

```{r}
country1 =
  geo_df |>
  group_by(country)|>
  summarise(n = n()) |>
  arrange(desc(n)) |>
  head(5) |>
  ggplot(aes(x = reorder(country, -n), y = n, fill = country)) +
  geom_bar(stat = "identity", width = 0.6) +
  labs(title = "Top Five Countries with the Most Volcanoes",
       x = "Country",
       y = "Number of Volcanoes") 


country2 =
  geo_df |>
  group_by(country)|>
  summarise(n = sum(eruption_count)) |>
  arrange(desc(n)) |>
  head(5) |>
  ggplot(aes(x = reorder(country, -n), y = n, fill = country)) +
  geom_bar(stat = "identity", width = 0.6) +
  labs(title = "Top Five Countries with the Most Volcanic Eruptions",
       x = "Country",
       y = "Number of Eruptions") 

plot_grid(country1, country2, ncol = 1)
```

The top five countries with the most volcanoes are: Indonesia, Japan, United States, Papua New Guinea and Russia.  
The top five countries with the most volcanic eruptions are: Indonesia, Japan, Italy, Iceland and United States.

## The Factors Influencing Casualties and Property Losses Caused by Volcanic Activity(numeric)

In this section, we aim to explore the impact of various factors(the occurrence of tsunami and earthquake, the type of volcano and the volcanic explosivity index) on casualties and property losses resulting from volcanic eruptions.

### Tidy Data

```{r}
numeric_df = 
  tidy_df |> 
  select(year,flag_tsunami,flag_earthquake,
         volcano_type, volcanic_explosivity_index,
         volcano_injuries, volcano_deaths, volcano_damage_in_m, volcano_houses_destroyed) |>
  mutate(
    flag_tsunami = factor(flag_tsunami),
    flag_earthquake = factor(flag_earthquake),
    volcanic_explosivity_index = factor(volcanic_explosivity_index))
```

## Time Distribution of Volcanic Eruptions

### Tidy data
```{r}
voc_year <- tidy_df%>%
  group_by(year,volcanic_explosivity_index)%>%
  summarise(count = n())
```

```{r}
voc_year$period <- ifelse(voc_year$year < 0, "Before Christ",
ifelse(voc_year$year <= 1000, "0-1000",
ifelse(voc_year$year <= 1500, "1000-1500",
ifelse(voc_year$year <= 1899, "1500-1900",
ifelse(tidy_df$year <= 1999, "20th century", "21st century"))))) 

voc_year$period <- factor(voc_year$period, levels = c("Before Christ", "0-1000", "1000-1500", "1500-1900", "20th century","21st century"))
```

#### Plot 1: Volcanic Explosivity Index Frequency Over Periods
```{r}
expo_frequency<- voc_year%>%
  select(period,volcanic_explosivity_index)%>%
  group_by(period)%>%
  summarise(count = n()) 
```

```{r}
ggplot(expo_frequency,aes(x = period, y = count))+
  geom_bar(stat="identity",fill = "#D04F4F")+
  labs(
    x = "Period",
    y = "Count",
    title = "Volcanic Explosivity Index Frequency Over Periods"
  )
```

#### Plot2: Volcanic Explosivity Index Count Over Periods
```{r}
expo <- voc_year%>%
  select(period,volcanic_explosivity_index)%>%
  group_by(period,volcanic_explosivity_index)%>%
  summarise(count = n())
```

```{r,fig.width=9}
ggplot(expo,aes(x = period, y = count,fill = volcanic_explosivity_index))+
  geom_bar(stat="identity", position="stack") +
   labs(
    x = "Period",
    y = "Count",
    title = "Volcanic Explosivity Index Count Over Periods"
  )
```

### Tidy Data 2
```{r}
time_df <- tidy_df |>
  filter(year > 1900) |>
  mutate(
    volcano_deaths = replace(volcano_deaths, is.na(volcano_deaths), 0),
    volcano_injuries = replace(volcano_injuries, is.na(volcano_injuries), 0),
    volcano_damage_in_m = replace(volcano_damage_in_m, is.na(volcano_damage_in_m), 0),
    volcano_houses_destroyed = replace(volcano_houses_destroyed, is.na(volcano_houses_destroyed), 0),
    year = as.character(year)
  ) |>
group_by(year) |>
  summarize(
    total_deaths = sum(volcano_deaths,na.rm = TRUE),
    total_injuries = sum(volcano_injuries,na.rm = TRUE),
    total_damage = sum(volcano_damage_in_m,na.rm = TRUE),
    total_house_destruction = sum(volcano_houses_destroyed,na.rm = TRUE)
  )

```

#### Plot 3:Analysis of Toal Deaths and Total Injuries Over Time
```{r}
ggplot(time_df, aes(x = as.numeric(year))) +
  geom_line(aes(y = total_deaths, color = "Deaths"), size = 1) +
  geom_line(aes(y = total_injuries, color = "Injuries"), size = 1) +
  labs(
    title = "Analysis of Toal Deaths and Total Injuries Over Time",
    x = "Year",
    y = "Count",
    color = "Variable"
  )
```

#### Plot 4: Analysis of Total Damage and House Destruction Over Time
```{r}
ggplot(time_df, aes(x = as.numeric(year))) +
  geom_line(aes(y = total_damage, color = "Damage"), size = 1) +
  geom_line(aes(y = total_house_destruction, color = "House Destruction"), size = 1)+
  labs(
    title = "Analysis of Total Damage and House Destruction Over Time",
    x = "Year",
    y = "Count",
    color = "Variable"
  ) 
```




